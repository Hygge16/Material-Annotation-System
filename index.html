<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Material Annotation Management System</title>
<style>
  :root{
    --green: rgba(34,197,94,0.3);
    --green-stroke: rgba(34,197,94,1);
    --text-color: #333;
    --accent: #10b981;
    --danger: #ef4444;
    --bg: #f6f7fb;
    --card:#fff;
    --gray: #9ca3af;
  }
  body{margin:0;font-family:Inter, "Segoe UI", Roboto, Arial;background:var(--bg);color:var(--text-color);display:flex;gap:12px;padding:14px;box-sizing:border-box;}
  .left{width:360px;flex-shrink:0;display:flex;flex-direction:column;gap:10px}
  .panel{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 20px rgba(16,24,40,0.06)}
  h3{margin:0 0 8px 0;font-size:15px}
  .controls{display:flex;gap:8px;align-items:center}
  input[type="text"]{flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}
  .btn{padding:8px 10px;border-radius:8px;border:1px solid #e6e9ef;background:#fff;cursor:pointer;font-size:13px;transition:all 0.2s}
  .btn.primary{background:var(--accent);color:#fff;border:none}
  .btn.danger{background:var(--danger);color:#fff;border:none}
  .btn.screenshot{background:#3b82f6;color:#fff;border:none}
  .btn.hide-labels{background:#f59e0b;color:#fff;border:none}
  .btn.locked{background:var(--gray);color:#fff;border:none;cursor:not-allowed;opacity:0.7}
  .small{font-size:12px;padding:6px 8px}
  .list{margin-top:8px;display:flex;flex-direction:column;gap:6px;max-height:54vh;overflow:auto}
  .imgItem{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid transparent;cursor:pointer;transition:all 0.2s}
  .imgItem.active{border:1px solid rgba(16,24,40,0.06);background:#fbfeff}
  .meta{font-size:12px;color:#555}
  .right{flex:1;display:flex;flex-direction:column;gap:8px}
  .map-wrap{background:#fff;border-radius:10px;overflow:hidden;position:relative;box-shadow:0 8px 20px rgba(16,24,40,0.06);min-height:480px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
  }
  .map-img{
    max-width: 100%;
    max-height: 80vh;
    height: auto;
    display: block;
    user-select: none;
  }
  svg.overlay{
    position:absolute;
    left:0;
    top:0;
    width:100%;
    height:100%;
    pointer-events:none;
  }
  .rect{fill:var(--green);stroke:var(--green-stroke);stroke-width:2;opacity:1;transition:all .2s}
  .rect.pulse{animation:highlight 1.5s infinite ease-in-out}
  .rect.selected{stroke:var(--danger);stroke-width:3}
  @keyframes highlight{
    0%{filter:drop-shadow(0 3px 9px rgba(34,197,94,0.12))}
    50%{transform:scale(1.01);filter:drop-shadow(0 6px 12px rgba(34,197,94,0.2))}
    100%{filter:drop-shadow(0 3px 9px rgba(34,197,94,0.12))}
  }
  .handle{width:10px;height:10px;fill:#fff;stroke:var(--green-stroke);stroke-width:2;cursor:se-resize;pointer-events:auto}
  .annotation-label{
    position:absolute;
    background:rgba(255,255,255,0.95);
    border:1px solid var(--green-stroke);
    border-radius:4px;
    padding:2px 6px;
    font-size:12px;
    white-space:nowrap;
    pointer-events:none;
    color:var(--text-color);
    transition:all .2s;
    z-index:10;
    max-width: 120px;
    text-overflow: ellipsis;
    overflow: hidden;
  }
  .annotation-label.hidden{
    opacity: 0;
    pointer-events: none;
  }
  .tagLabel{position:absolute;background:rgba(255,255,255,0.95);border-radius:6px;padding:6px 8px;border:1px solid rgba(0,0,0,0.06);font-size:13px;pointer-events:none;box-shadow:0 6px 18px rgba(10,10,10,0.06)}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .hint{font-size:12px;color:#666;margin-top:6px;line-height:1.4}
  /* 移除截图加载样式 */
  /* 管理员弹窗样式*/
  .admin-modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.5);
    display:flex;
    justify-content:center;
    align-items:center;
    z-index:9999; /* 显示在最上层 */
  }
  .modal-content{
    background:white;
    padding:20px;
    border-radius:10px;
    width:300px;
    box-shadow:0 4px 20px rgba(0,0,0,0.15);
  }
  .modal-content h3{
    margin-bottom:15px;
    text-align:center;
  }
  .password-input{
    width:100%;
    padding:10px;
    margin-bottom:15px;
    border:1px solid #ddd;
    border-radius:6px;
    box-sizing:border-box;
  }
  .modal-buttons{
    display:flex;
    gap:10px;
  }
  .modal-btn{
    flex:1;
    padding:8px;
    border-radius:6px;
    border:none;
    cursor:pointer;
  }
  .modal-btn.confirm{
    background:var(--accent);
    color:white;
  }
  .modal-btn.cancel{
    background:#eee;
  }
  .password-error{
    color:var(--danger);
    font-size:12px;
    text-align:center;
    margin-bottom:10px;
    display:none;
  }
  @media (max-width:900px){body{flex-direction:column}.left{width:100%}}
</style>
</head>
<body>
  <div class="left">
    <div class="panel">
      <div class="topbar">
        <h3>物料标注控制</h3>
        <div style="display:flex;gap:6px;align-items:center">
          <input id="fileInput" type="file" accept="image/*" multiple style="display:none" />
          <button class="btn small upload-btn" id="uploadBtn">上传图片</button>
          <button class="btn small export-btn" id="exportBtn">导出</button>
        </div>
      </div>

      <div style="margin-top:8px" class="controls">
        <input id="searchInput" type="text" placeholder="搜索物料名称" />
        <button id="clearBtn" class="btn small">清除</button>
        <button id="screenshotBtn" class="btn small screenshot">截图</button>
      </div>

      <div style="margin-top:8px" class="controls">
        <button id="markToggle" class="btn small locked">标注模式</button>
        <button id="hideLabelsBtn" class="btn small hide-labels">隐藏名称框</button>
        <button id="delMode" class="btn small locked">删除模式</button>
        <button id="importBtn" class="btn small import-btn locked">导入</button>
      </div>

      <div class="list" id="imageList" style="margin-top:10px"></div>

      <div class="hint">
        1.「标注模式」或「删除模式」仅在管理者模式下可使用<br>
        2.正常查询物料不需要进入管理者模式
      </div>
    </div>
  </div>

  <div class="right">
    <div class="panel topbar" style="align-items:center;gap:12px">
      <div>
        <h3 id="imgTitle">未选择图片</h3>
        <div class="meta" id="imgMeta">0 个标注</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <select id="imageSelect" class="btn small"></select>
        <button id="prevBtn" class="btn small">◀</button>
        <button id="nextBtn" class="btn small">▶</button>
        <button id="saveBtn" class="btn small primary locked">保存</button>
      </div>
    </div>

    <div class="map-wrap panel" id="mapWrap">
      <img id="mapImg" class="map-img" src="" alt="请上传图片" />
      <div id="annotationLabels" class="annotation-labels" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;"></div>
      <svg id="overlay" class="overlay" xmlns="http://www.w3.org/2000/svg"></svg>
      <div id="labelBox" class="tagLabel" style="display:none"></div>
      <!-- 移除截图加载元素 -->
    </div>
  </div>

  <!-- 管理员密码弹窗 - 默认隐藏，但确保结构存在 -->
  <div class="admin-modal" id="adminModal">
    <div class="modal-content">
      <h3>管理员验证 仅查询点击取消即可</h3>
      <div class="password-error" id="passwordError">密码错误，请重试</div>
      <input type="password" class="password-input" id="adminPassword" placeholder="请输入管理员密码" />
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="cancelAuth">取消</button>
        <button class="modal-btn confirm" id="confirmAuth">确认</button>
      </div>
    </div>
  </div>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
// --- 核心变量 ---
const storeKey = 'material_annotation_with_permission';
const ADMIN_PASSWORD = '1'; // 明确设置密码
let appData = { images: [] };
let currentImageIndex = -1;
let isMarkMode = false;
let isDeleteMode = false;
let dragState = null;
let selectedAnnId = null;
let searchText = '';
let originalImageSize = { width: 0, height: 0 };
let mapWrapRectCache = null;
let isLabelsHidden = false;
let isAdmin = false;

// --- DOM元素缓存 ---
const DOM = {
  // 基础元素
  fileInput: document.getElementById('fileInput'),
  uploadBtn: document.getElementById('uploadBtn'),
  exportBtn: document.getElementById('exportBtn'),
  searchInput: document.getElementById('searchInput'),
  clearBtn: document.getElementById('clearBtn'),
  screenshotBtn: document.getElementById('screenshotBtn'),
  markToggle: document.getElementById('markToggle'),
  hideLabelsBtn: document.getElementById('hideLabelsBtn'),
  delMode: document.getElementById('delMode'),
  importBtn: document.getElementById('importBtn'),
  imageList: document.getElementById('imageList'),
  imageSelect: document.getElementById('imageSelect'),
  imgTitle: document.getElementById('imgTitle'),
  imgMeta: document.getElementById('imgMeta'),
  prevBtn: document.getElementById('prevBtn'),
  nextBtn: document.getElementById('nextBtn'),
  saveBtn: document.getElementById('saveBtn'),
  mapImg: document.getElementById('mapImg'),
  overlay: document.getElementById('overlay'),
  labelBox: document.getElementById('labelBox'),
  mapWrap: document.getElementById('mapWrap'),
  annotationLabels: document.getElementById('annotationLabels'),
  // 移除截图加载元素引用
  
  // 权限相关元素 - 确保能获取到
  adminModal: document.getElementById('adminModal'),
  adminPassword: document.getElementById('adminPassword'),
  passwordError: document.getElementById('passwordError'),
  confirmAuth: document.getElementById('confirmAuth'),
  cancelAuth: document.getElementById('cancelAuth')
};

// --- 初始化应用 ---
function initApp() {
  // 强制检查弹窗元素是否存在
  if (!DOM.adminModal) {
    alert('检测到页面结构不完整，正在修复...');
    createModalIfMissing();
  }
  
  bindBaseEvents();
  loadFromLocalStorage();
  renderImageList();
  if (appData.images.length > 0) {
    selectImage(0);
  }
  updatePermissionState();
  
  // 调试：确认弹窗元素已加载
  console.log('弹窗元素状态:', DOM.adminModal ? '存在' : '不存在');
}

// 确保弹窗元素存在的安全机制
function createModalIfMissing() {
  const modal = document.createElement('div');
  modal.className = 'admin-modal';
  modal.id = 'adminModal';
  modal.innerHTML = `
    <div class="modal-content">
      <h3>管理员验证 仅查询点击取消即可</h3>
      <div class="password-error" id="passwordError">密码错误，请重试</div>
      <input type="password" class="password-input" id="adminPassword" placeholder="请输入管理员密码" />
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="cancelAuth">取消</button>
        <button class="modal-btn confirm" id="confirmAuth">确认</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  // 重新获取DOM元素
  DOM.adminModal = document.getElementById('adminModal');
  DOM.adminPassword = document.getElementById('adminPassword');
  DOM.passwordError = document.getElementById('passwordError');
  DOM.confirmAuth = document.getElementById('confirmAuth');
  DOM.cancelAuth = document.getElementById('cancelAuth');
}

// --- 权限控制核心函数 ---
function updatePermissionState() {
  if (isAdmin) {
    // 解锁所有按钮
    ['markToggle', 'delMode', 'importBtn', 'saveBtn', 'uploadBtn', 'exportBtn'].forEach(id => {
      DOM[id].classList.remove('locked');
      DOM[id].disabled = false;
    });
    showLabel('已获得管理员权限，可进行编辑操作', 20, 20);
    setTimeout(hideLabel, 3000);
  } else {
    // 锁定编辑按钮
    ['markToggle', 'delMode', 'importBtn', 'saveBtn', 'uploadBtn', 'exportBtn'].forEach(id => {
      DOM[id].classList.add('locked');
      DOM[id].disabled = true;
    });
  }
}

// 强制显示弹窗的函数
function showAdminAuthModal() {
  // 确保弹窗能显示
  if (DOM.adminModal) {
    DOM.adminPassword.value = '';
    DOM.passwordError.style.display = 'none';
    DOM.adminModal.style.display = 'flex'; // 强制设置为显示
    DOM.adminPassword.focus();
    console.log('弹窗已显示');
  } else {
    alert('弹窗元素缺失，已尝试修复，请重试');
    createModalIfMissing();
    showAdminAuthModal();
  }
}

function hideAdminAuthModal() {
  if (DOM.adminModal) {
    DOM.adminModal.style.display = 'none';
  }
}

function verifyAdminPassword(password) {
  return password === ADMIN_PASSWORD;
}

// --- 绑定基础事件 ---
function bindBaseEvents() {
  // 简化按钮点击事件，确保弹窗能触发
  DOM.markToggle.addEventListener('click', function() {
    console.log('标注模式按钮被点击');
    if (!isAdmin) {
      // 强制显示弹窗
      showAdminAuthModal();
    } else {
      toggleMarkMode();
    }
  });
  
  DOM.delMode.addEventListener('click', function() {
    console.log('删除模式按钮被点击');
    if (!isAdmin) {
      // 强制显示弹窗
      showAdminAuthModal();
    } else {
      toggleDeleteMode();
    }
  });
  
  // 密码验证事件
  DOM.confirmAuth.addEventListener('click', function() {
    const password = DOM.adminPassword.value.trim();
    if (verifyAdminPassword(password)) {
      isAdmin = true;
      hideAdminAuthModal();
      updatePermissionState();
    } else {
      DOM.passwordError.style.display = 'block';
      DOM.adminPassword.focus();
    }
  });
  
  DOM.cancelAuth.addEventListener('click', hideAdminAuthModal);
  
  // 支持按Enter键验证
  DOM.adminPassword.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      DOM.confirmAuth.click();
    }
  });

  // 其他事件保持不变
  DOM.uploadBtn.addEventListener('click', () => {
    if (isAdmin) {
      DOM.fileInput.value = '';
      DOM.fileInput.click();
    }
  });
  DOM.fileInput.addEventListener('change', handleImageUpload);
  
  DOM.prevBtn.addEventListener('click', () => switchImage(-1));
  DOM.nextBtn.addEventListener('click', () => switchImage(1));
  DOM.imageSelect.addEventListener('change', () => selectImage(parseInt(DOM.imageSelect.value)));
  
  DOM.saveBtn.addEventListener('click', saveToLocalStorage);
  DOM.exportBtn.addEventListener('click', exportData);
  DOM.importBtn.addEventListener('click', importData);
  
  DOM.clearBtn.addEventListener('click', clearSearch);
  DOM.searchInput.addEventListener('input', handleSearch);
  DOM.screenshotBtn.addEventListener('click', takeSearchResultScreenshot);
  
  DOM.hideLabelsBtn.addEventListener('click', toggleLabelsVisibility);
  
  window.addEventListener('resize', debounce(syncOverlaySize, 30));
  DOM.mapImg.addEventListener('load', handleImageLoadComplete);
  
  const observer = new ResizeObserver(entries => {
    if (entries.length) syncOverlaySize();
  });
  observer.observe(DOM.mapWrap);
  
  document.addEventListener('keydown', handleKeyDown);
}

// --- 截图功能修改 ---
function takeSearchResultScreenshot() {
  if (!searchText.trim()) {
    alert('请先输入搜索关键词，显示匹配结果后再截图');
    return;
  }
  
  const matchedCount = getMatchedAnnotationIds().length;
  if (matchedCount === 0) {
    alert('没有匹配的标注结果，无法截图');
    return;
  }
  
  if (currentImageIndex < 0 || !DOM.mapImg.complete) {
    alert('请先选择并加载图片');
    return;
  }
  
  const wasHidden = isLabelsHidden;
  if (wasHidden) {
    isLabelsHidden = false;
    updateLabelsVisibility();
  }
  
  // 移除"正在生成截图"提示的显示代码
  
  html2canvas(DOM.mapWrap, {
    useCORS: true,
    logging: false,
    scale: window.devicePixelRatio || 1,
    backgroundColor: null
  }).then(canvas => {
    if (wasHidden) {
      isLabelsHidden = true;
      updateLabelsVisibility();
    }
    
    // 移除隐藏提示的代码
    
    const link = document.createElement('a');
    const fileName = `搜索结果_${searchText}_${new Date().toLocaleString().replace(/[\/: ]/g, '-')}.png`;
    link.download = fileName;
    link.href = canvas.toDataURL('image/png');
    link.click();
  }).catch(err => {
    if (wasHidden) {
      isLabelsHidden = true;
      updateLabelsVisibility();
    }
    
    // 移除隐藏提示的代码
    console.error('截图失败:', err);
    alert('截图失败，请重试');
  });
}

// --- 以下是其他保持不变的功能函数 ---
function toggleLabelsVisibility() {
  isLabelsHidden = !isLabelsHidden;
  DOM.hideLabelsBtn.textContent = isLabelsHidden ? '显示名称框' : '隐藏名称框';
  updateLabelsVisibility();
  
  const tipText = isLabelsHidden ? '已临时隐藏所有名称框' : '已显示所有名称框';
  showLabel(tipText, 20, 20);
  setTimeout(hideLabel, 2000);
}

function updateLabelsVisibility() {
  const allLabels = DOM.annotationLabels.querySelectorAll('.annotation-label');
  allLabels.forEach(label => {
    const forceShow = searchText.trim() !== '' || (document.activeElement === DOM.screenshotBtn);
    label.classList.toggle('hidden', isLabelsHidden && !forceShow);
  });
}

function handleImageLoadComplete() {
  originalImageSize.width = DOM.mapImg.naturalWidth;
  originalImageSize.height = DOM.mapImg.naturalHeight;
  mapWrapRectCache = DOM.mapWrap.getBoundingClientRect();
  syncOverlaySize();
}

function handleImageUpload(e) {
  if (!isAdmin) return;
  
  const files = e.target.files;
  if (!files || files.length === 0) return;

  const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
  if (imageFiles.length === 0) {
    alert('请选择图片文件（支持JPG、PNG等格式）');
    return;
  }

  let successCount = 0;
  imageFiles.forEach(file => {
    const reader = new FileReader();
    reader.onload = function (event) {
      if (!appData.images) appData.images = [];
      
      appData.images.push({
        id: generateUniqueId('img'),
        name: file.name,
        dataURL: event.target.result,
        annotations: []
      });
      successCount++;

      if (successCount === imageFiles.length) {
        saveToLocalStorage();
        renderImageList();
        if (currentImageIndex === -1) {
          selectImage(appData.images.length - imageFiles.length);
        }
        alert(`成功上传 ${successCount} 张图片`);
      }
    };
    reader.onerror = () => alert(`图片 "${file.name}" 读取失败`);
    reader.readAsDataURL(file);
  });
}

function deleteImage(index) {
  if (!isAdmin) return;
  
  if (index < 0 || index >= appData.images.length) return;
  
  const image = appData.images[index];
  if (confirm(`确定删除图片「${image.name || '未命名图片'}」及所有标注吗？`)) {
    appData.images.splice(index, 1);
    saveToLocalStorage();
    
    if (appData.images.length === 0) {
      currentImageIndex = -1;
      selectImage(-1);
    } else {
      if (index === currentImageIndex) {
        const newIndex = index > 0 ? index - 1 : 0;
        selectImage(newIndex);
      } else {
        if (index < currentImageIndex) {
          currentImageIndex--;
        }
        renderImageList();
      }
    }
  }
}

function selectImage(index) {
  if (index < 0 || index >= appData.images.length) {
    DOM.mapImg.src = '';
    DOM.imgTitle.textContent = '未选择图片';
    DOM.imgMeta.textContent = '0 个标注';
    clearOverlay();
    clearAnnotationLabels();
    currentImageIndex = -1;
    originalImageSize = { width: 0, height: 0 };
    mapWrapRectCache = null;
    return;
  }
  
  currentImageIndex = index;
  const image = appData.images[index];
  
  DOM.mapImg.src = image.dataURL;
  DOM.imgTitle.textContent = image.name || `图片 ${index + 1}`;
  if (!image.annotations) image.annotations = [];
  DOM.imgMeta.textContent = `${image.annotations.length} 个标注`;
  
  selectedAnnId = null;
  renderImageList();
  originalImageSize = { width: 0, height: 0 };
  mapWrapRectCache = null;
}

function switchImage(step) {
  if (appData.images.length === 0) return;
  const newIndex = (currentImageIndex + step + appData.images.length) % appData.images.length;
  selectImage(newIndex);
}

function renderImageList() {
  DOM.imageList.innerHTML = '';
  DOM.imageSelect.innerHTML = '';

  if (appData.images.length === 0) {
    DOM.imageSelect.innerHTML = '<option>（无图片）</option>';
    return;
  }

  appData.images.forEach((image, index) => {
    if (!image.annotations) image.annotations = [];
    
    const listItem = document.createElement('div');
    listItem.className = `imgItem ${index === currentImageIndex ? 'active' : ''}`;
    
    const deleteButton = isAdmin ? `
      <button class="btn small danger delete-img" data-index="${index}">删</button>
    ` : '';
    
    listItem.innerHTML = `
      <div>
        <div style="font-weight:600">${image.name || `图片 ${index + 1}`}</div>
        <div class="meta">${image.annotations.length} 个标注</div>
      </div>
      <div style="display:flex;gap:4px">
        <button class="btn small select-img" data-index="${index}">选</button>
        ${deleteButton}
      </div>
    `;
    
    listItem.querySelector('.select-img').addEventListener('click', () => selectImage(index));
    
    const delBtn = listItem.querySelector('.delete-img');
    if (delBtn) {
      delBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        deleteImage(index);
      });
    }
    
    DOM.imageList.appendChild(listItem);

    const option = document.createElement('option');
    option.value = index;
    option.textContent = image.name || `图片 ${index + 1}`;
    option.selected = index === currentImageIndex;
    DOM.imageSelect.appendChild(option);
  });
}

function syncOverlaySize() {
  if (!DOM.mapImg.complete || currentImageIndex < 0 || originalImageSize.width === 0) return;
  
  mapWrapRectCache = DOM.mapWrap.getBoundingClientRect();
  const imgRect = DOM.mapImg.getBoundingClientRect();
  
  DOM.overlay.setAttribute('width', mapWrapRectCache.width);
  DOM.overlay.setAttribute('height', mapWrapRectCache.height);
  DOM.overlay.style.left = '0';
  DOM.overlay.style.top = '0';
  DOM.overlay.style.pointerEvents = (isMarkMode && isAdmin) || (isDeleteMode && isAdmin) ? 'auto' : 'none';
  
  drawAllAnnotations();
  drawAnnotationLabels();
}

function drawAllAnnotations() {
  clearOverlay();
  if (currentImageIndex < 0 || !appData.images[currentImageIndex] || originalImageSize.width === 0 || !mapWrapRectCache) return;

  const image = appData.images[currentImageIndex];
  if (!image.annotations) image.annotations = [];
  
  const imgRect = DOM.mapImg.getBoundingClientRect();
  const highlightIds = getMatchedAnnotationIds();

  const imgOffsetX = (mapWrapRectCache.width - imgRect.width) / 2;
  const imgOffsetY = (mapWrapRectCache.height - imgRect.height) / 2;

  image.annotations.forEach(ann => {
    const x = (ann.x / 100 * imgRect.width) + imgOffsetX;
    const y = (ann.y / 100 * imgRect.height) + imgOffsetY;
    const width = ann.w / 100 * imgRect.width;
    const height = ann.h / 100 * imgRect.height;

    const shouldShow = (isMarkMode && isAdmin) || (isDeleteMode && isAdmin) || highlightIds.includes(ann.id);
    if (!shouldShow) return;

    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('x', x.toFixed(2));
    rect.setAttribute('y', y.toFixed(2));
    rect.setAttribute('width', width.toFixed(2));
    rect.setAttribute('height', height.toFixed(2));
    rect.setAttribute('rx', 4);
    rect.setAttribute('ry', 4);
    rect.classList.add('rect');
    if (highlightIds.includes(ann.id) && !((isMarkMode && isAdmin) || (isDeleteMode && isAdmin))) {
      rect.classList.add('pulse');
    }
    if (ann.id === selectedAnnId) rect.classList.add('selected');
    rect.dataset.aid = ann.id;
    rect.style.pointerEvents = (isMarkMode || isDeleteMode) && isAdmin ? 'auto' : 'none';
    DOM.overlay.appendChild(rect);

    if (isMarkMode && isAdmin) {
      const handle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      handle.setAttribute('cx', (x + width).toFixed(2));
      handle.setAttribute('cy', (y + height).toFixed(2));
      handle.setAttribute('r', 6);
      handle.classList.add('handle');
      handle.dataset.aid = ann.id;
      DOM.overlay.appendChild(handle);

      rect.addEventListener('mousedown', (e) => startDrag(e, ann.id, 'move'));
      handle.addEventListener('mousedown', (e) => startDrag(e, ann.id, 'resize'));
    }
    
    rect.addEventListener('click', (e) => handleAnnotationClick(e, ann.id));
  });
}

function drawAnnotationLabels() {
  clearAnnotationLabels();
  if (currentImageIndex < 0 || !appData.images[currentImageIndex] || originalImageSize.width === 0 || !mapWrapRectCache) return;

  const image = appData.images[currentImageIndex];
  if (!image.annotations) image.annotations = [];
  
  const imgRect = DOM.mapImg.getBoundingClientRect();
  const highlightIds = getMatchedAnnotationIds();

  const imgOffsetX = (mapWrapRectCache.width - imgRect.width) / 2;
  const imgOffsetY = (mapWrapRectCache.height - imgRect.height) / 2;

  image.annotations.forEach(ann => {
    const shouldShow = (isMarkMode && isAdmin) || (isDeleteMode && isAdmin) || highlightIds.includes(ann.id);
    if (!shouldShow) return;

    const x = (ann.x / 100) * imgRect.width + imgOffsetX;
    const y = (ann.y / 100) * imgRect.height + imgOffsetY;
    const width = (ann.w / 100) * imgRect.width;
    const height = (ann.h / 100) * imgRect.height;

    let labelX, labelY;
    if (x + width + 10 + 120 < mapWrapRectCache.width) {
      labelX = x + width + 5;
      labelY = y - 2;
    } else if (x - 10 - 120 > 0) {
      labelX = x - 120 - 5;
      labelY = y - 2;
    } else if (y + height + 20 < mapWrapRectCache.height) {
      labelX = x;
      labelY = y + height + 5;
    } else {
      labelX = x;
      labelY = y - 20;
    }

    const label = document.createElement('div');
    label.className = 'annotation-label';
    label.textContent = ann.label;
    label.dataset.aid = ann.id;
    label.style.left = `${labelX.toFixed(2)}px`;
    label.style.top = `${labelY.toFixed(2)}px`;

    DOM.annotationLabels.appendChild(label);
  });

  updateLabelsVisibility();
}

function clearAnnotationLabels() {
  while (DOM.annotationLabels.firstChild) {
    DOM.annotationLabels.removeChild(DOM.annotationLabels.firstChild);
  }
}

function toggleMarkMode() {
  if (!isAdmin) return;
  
  isMarkMode = !isMarkMode;
  DOM.markToggle.classList.toggle('primary', isMarkMode);
  
  if (isMarkMode && isDeleteMode) {
    isDeleteMode = false;
    DOM.delMode.classList.remove('primary');
  }

  if (isMarkMode) {
    DOM.mapWrap.addEventListener('mousedown', startDrawing, true);
    showLabel('标注模式：创建/编辑标注', 20, 20);
  } else {
    DOM.mapWrap.removeEventListener('mousedown', startDrawing, true);
    hideLabel();
  }

  DOM.overlay.style.pointerEvents = (isMarkMode || isDeleteMode) && isAdmin ? 'auto' : 'none';
  drawAllAnnotations();
  drawAnnotationLabels();
}

function startDrawing(e) {
  if (!isMarkMode || !isAdmin || isDeleteMode || dragState || currentImageIndex < 0 || originalImageSize.width === 0 || !mapWrapRectCache) return;
  
  if (e.target.closest('.rect') || e.target.closest('.handle') || e.target.closest('.annotation-label')) return;

  e.stopPropagation();
  const startPos = clientToPercent(e.clientX, e.clientY);
  
  dragState = {
    type: 'draw',
    startX: startPos.x,
    startY: startPos.y,
    tempId: generateUniqueId('temp')
  };

  document.addEventListener('mousemove', drawTemporaryRect);
  document.addEventListener('mouseup', finishDrawing);
}

function drawTemporaryRect(e) {
  if (!dragState || dragState.type !== 'draw' || !isAdmin || originalImageSize.width === 0 || !mapWrapRectCache) return;

  const currentPos = clientToPercent(e.clientX, e.clientY);
  const x = Math.min(dragState.startX, currentPos.x);
  const y = Math.min(dragState.startY, currentPos.y);
  const width = Math.abs(currentPos.x - dragState.startX);
  const height = Math.abs(currentPos.y - dragState.startY);

  const existingTemp = document.querySelector(`[data-temp-id="${dragState.tempId}"]`);
  if (existingTemp) existingTemp.remove();

  const imgRect = DOM.mapImg.getBoundingClientRect();
  const imgOffsetX = (mapWrapRectCache.width - imgRect.width) / 2;
  const imgOffsetY = (mapWrapRectCache.height - imgRect.height) / 2;
  
  const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  rect.setAttribute('x', ((x / 100) * imgRect.width + imgOffsetX).toFixed(2));
  rect.setAttribute('y', ((y / 100) * imgRect.height + imgOffsetY).toFixed(2));
  rect.setAttribute('width', ((width / 100) * imgRect.width).toFixed(2));
  rect.setAttribute('height', ((height / 100) * imgRect.height).toFixed(2));
  rect.setAttribute('rx', 4);
  rect.setAttribute('ry', 4);
  rect.setAttribute('fill', 'rgba(34,197,94,0.28)');
  rect.setAttribute('stroke', 'rgba(34,197,94,1)');
  rect.setAttribute('stroke-width', 2);
  rect.dataset.tempId = dragState.tempId;
  DOM.overlay.appendChild(rect);
}

function finishDrawing(e) {
  if (!dragState || dragState.type !== 'draw' || !isAdmin || currentImageIndex < 0 || originalImageSize.width === 0 || !mapWrapRectCache) {
    cleanupDrawingState();
    return;
  }

  const tempRect = document.querySelector(`[data-temp-id="${dragState.tempId}"]`);
  if (tempRect) tempRect.remove();

  const endPos = clientToPercent(e.clientX, e.clientY);
  const x = Math.min(dragState.startX, endPos.x);
  const y = Math.min(dragState.startY, endPos.y);
  const width = Math.max(0.1, Math.abs(endPos.x - dragState.startX));
  const height = Math.max(0.1, Math.abs(endPos.y - dragState.startY));

  if (width >= 0.1 && height >= 0.1) {
    const label = prompt('请输入物料名称：', '');
    if (label !== null && label.trim() !== '') {
      const currentImage = appData.images[currentImageIndex];
      if (!currentImage.annotations) {
        currentImage.annotations = [];
      }
      currentImage.annotations.push({
        id: generateUniqueId('ann'),
        label: label.trim(),
        x: x,
        y: y,
        w: width,
        h: height
      });
      
      saveToLocalStorage();
      DOM.imgMeta.textContent = `${currentImage.annotations.length} 个标注`;
      drawAllAnnotations();
      drawAnnotationLabels();
    }
  }

  cleanupDrawingState();
}

function cleanupDrawingState() {
  dragState = null;
  document.removeEventListener('mousemove', drawTemporaryRect);
  document.removeEventListener('mouseup', finishDrawing);
}

function startDrag(e, annId, type) {
  if (!isAdmin || isDeleteMode || originalImageSize.width === 0 || !mapWrapRectCache) return;
  e.stopPropagation();
  e.preventDefault();
  
  const ann = findAnnotationById(annId);
  if (!ann) return;

  dragState = {
    type,
    id: annId,
    startClientX: e.clientX,
    startClientY: e.clientY,
    originalX: ann.x,
    originalY: ann.y,
    originalW: ann.w,
    originalH: ann.h
  };

  document.addEventListener('mousemove', handleDragMove);
  document.addEventListener('mouseup', stopDrag);
}

function handleDragMove(e) {
  if (!dragState || !isAdmin || currentImageIndex < 0 || originalImageSize.width === 0 || !mapWrapRectCache) return;
  
  const ann = findAnnotationById(dragState.id);
  if (!ann) return;
  
  const imgRect = DOM.mapImg.getBoundingClientRect();

  if (dragState.type === 'move') {
    const dx = (e.clientX - dragState.startClientX) / imgRect.width * 100;
    const dy = (e.clientY - dragState.startClientY) / imgRect.height * 100;
    ann.x = parseFloat((Math.max(0, Math.min(100 - ann.w, dragState.originalX + dx))).toFixed(4));
    ann.y = parseFloat((Math.max(0, Math.min(100 - ann.h, dragState.originalY + dy))).toFixed(4));
  } else if (dragState.type === 'resize') {
    const dw = (e.clientX - dragState.startClientX) / imgRect.width * 100;
    const dh = (e.clientY - dragState.startClientY) / imgRect.height * 100;
    ann.w = parseFloat((Math.max(0.1, Math.min(100 - ann.x, dragState.originalW + dw))).toFixed(4));
    ann.h = parseFloat((Math.max(0.1, Math.min(100 - ann.y, dragState.originalH + dh))).toFixed(4));
  }

  drawAllAnnotations();
  drawAnnotationLabels();
}

function stopDrag() {
  if (!dragState || !isAdmin) return;
  if (dragState.type === 'move' || dragState.type === 'resize') {
    saveToLocalStorage();
  }
  dragState = null;
  document.removeEventListener('mousemove', handleDragMove);
  document.removeEventListener('mouseup', stopDrag);
}

function clientToPercent(clientX, clientY) {
  if (originalImageSize.width === 0 || !mapWrapRectCache) return { x: 0, y: 0 };
  
  const imgRect = DOM.mapImg.getBoundingClientRect();
  
  const imgOffsetX = (mapWrapRectCache.width - imgRect.width) / 2;
  const imgOffsetY = (mapWrapRectCache.height - imgRect.height) / 2;
  
  const relativeX = clientX - mapWrapRectCache.left - imgOffsetX;
  const relativeY = clientY - mapWrapRectCache.top - imgOffsetY;
  
  const x = parseFloat(((relativeX / imgRect.width) * 100).toFixed(4));
  const y = parseFloat(((relativeY / imgRect.height) * 100).toFixed(4));
  
  return {
    x: Math.max(-0.5, Math.min(100.5, x)),
    y: Math.max(-0.5, Math.min(100.5, y))
  };
}

function handleSearch(e) {
  searchText = e.target.value.trim().toLowerCase();
  drawAllAnnotations();
  drawAnnotationLabels();
  
  if (searchText) {
    const matchedCount = getMatchedAnnotationIds().length;
    if (matchedCount === 0) {
      showLabel(`未找到名称包含「${searchText}」的物料`, 20, 20);
    } else {
      showLabel(`找到 ${matchedCount} 个匹配的物料标注`, 20, 20);
    }
  } else {
    hideLabel();
  }
}

function clearSearch() {
  DOM.searchInput.value = '';
  searchText = '';
  drawAllAnnotations();
  drawAnnotationLabels();
  hideLabel();
}

function getMatchedAnnotationIds() {
  if (!searchText || currentImageIndex < 0 || !appData.images[currentImageIndex].annotations) return [];
  
  return appData.images[currentImageIndex].annotations
    .filter(ann => ann.label.toLowerCase().includes(searchText))
    .map(ann => ann.id);
}

function toggleDeleteMode() {
  if (!isAdmin) return;
  
  isDeleteMode = !isDeleteMode;
  DOM.delMode.classList.toggle('primary', isDeleteMode);
  
  if (isDeleteMode && isMarkMode) {
    isMarkMode = false;
    DOM.markToggle.classList.remove('primary');
    DOM.mapWrap.removeEventListener('mousedown', startDrawing, true);
  }

  if (isDeleteMode) {
    showLabel('删除模式：显示所有标注，点击删除', 20, 20);
  } else {
    hideLabel();
  }

  DOM.overlay.style.pointerEvents = (isMarkMode || isDeleteMode) && isAdmin ? 'auto' : 'none';
  drawAllAnnotations();
  drawAnnotationLabels();
}

function handleAnnotationClick(e, annId) {
  e.stopPropagation();
  const ann = findAnnotationById(annId);
  if (!ann) return;

  if (isDeleteMode && isAdmin) {
    if (confirm(`确定删除物料「${ann.label}」的标注吗？`)) {
      deleteAnnotation(annId);
    }
  } else if (isMarkMode && isAdmin) {
    selectedAnnId = annId;
    drawAllAnnotations();
    drawAnnotationLabels();
  }
}

function deleteAnnotation(annId) {
  if (!isAdmin || currentImageIndex < 0) return;
  
  const currentImage = appData.images[currentImageIndex];
  if (!currentImage.annotations) return;
  
  currentImage.annotations = currentImage.annotations.filter(ann => ann.id !== annId);
  
  if (selectedAnnId === annId) selectedAnnId = null;
  
  saveToLocalStorage();
  DOM.imgMeta.textContent = `${currentImage.annotations.length} 个标注`;
  drawAllAnnotations();
  drawAnnotationLabels();
}

function handleKeyDown(e) {
  if (isAdmin && (e.key === 'Delete' || e.key === 'Backspace') && selectedAnnId && !dragState) {
    const ann = findAnnotationById(selectedAnnId);
    if (ann && confirm(`确定删除物料「${ann.label}」的标注吗？`)) {
      deleteAnnotation(selectedAnnId);
    }
  }
}

function showLabel(text, x, y) {
  DOM.labelBox.style.display = 'block';
  DOM.labelBox.textContent = text;
  
  const wrapRect = mapWrapRectCache || DOM.mapWrap.getBoundingClientRect();
  const labelWidth = DOM.labelBox.offsetWidth || 100;
  const labelHeight = DOM.labelBox.offsetHeight || 30;

  if (x + labelWidth > wrapRect.width) x = wrapRect.width - labelWidth - 10;
  if (y + labelHeight > wrapRect.height) y = wrapRect.height - labelHeight - 10;
  x = Math.max(10, x);
  y = Math.max(10, y);

  DOM.labelBox.style.left = `${x}px`;
  DOM.labelBox.style.top = `${y}px`;
}

function hideLabel() {
  DOM.labelBox.style.display = 'none';
}

function debounce(func, wait) {
  let timeout;
  return function() {
    const context = this;
    const args = arguments;
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(context, args), wait);
  };
}

function generateUniqueId(prefix = 'id') {
  return `${prefix}-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
}

function findAnnotationById(annId) {
  if (currentImageIndex < 0 || !appData.images[currentImageIndex] || !appData.images[currentImageIndex].annotations) {
    return null;
  }
  return appData.images[currentImageIndex].annotations.find(ann => ann.id === annId);
}

function clearOverlay() {
  while (DOM.overlay.firstChild) {
    DOM.overlay.removeChild(DOM.overlay.firstChild);
  }
}

function loadFromLocalStorage() {
  try {
    const rawData = localStorage.getItem(storeKey);
    if (rawData) {
      appData = JSON.parse(rawData);
      if (!appData.images || !Array.isArray(appData.images)) {
        appData.images = [];
      }
      appData.images.forEach(img => {
        if (!img.annotations || !Array.isArray(img.annotations)) {
          img.annotations = [];
        }
      });
    }
  } catch (e) {
    console.error('加载本地存储失败：', e);
    appData = { images: [] };
    alert('本地存储数据损坏，已重置');
  }
}

function saveToLocalStorage() {
  try {
    localStorage.setItem(storeKey, JSON.stringify(appData));
  } catch (e) {
    console.error('保存本地存储失败：', e);
    alert('保存数据失败，请检查浏览器存储权限');
  }
}

function exportData() {
  if (!isAdmin) return;
  
  if (appData.images.length === 0) {
    alert('没有数据可导出');
    return;
  }
  
  const dataStr = JSON.stringify(appData, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `物料标注数据_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
  a.click();
  
  URL.revokeObjectURL(url);
}

function importData() {
  if (!isAdmin) return;
  
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const importedData = JSON.parse(event.target.result);
        if (importedData && Array.isArray(importedData.images)) {
          appData = importedData;
          saveToLocalStorage();
          currentImageIndex = appData.images.length > 0 ? 0 : -1;
          renderImageList();
          if (currentImageIndex >= 0) {
            selectImage(currentImageIndex);
          }
          alert(`成功导入 ${appData.images.length} 张图片及标注`);
        } else {
          alert('导入失败：数据格式不正确');
        }
      } catch (err) {
        alert(`导入失败：${err.message}`);
      }
    };
    reader.readAsText(file);
  };
  
  input.click();
}

// --- 启动应用 ---
initApp();

// 额外的安全机制：页面加载完成后检查弹窗是否能显示
window.addEventListener('load', function() {
  setTimeout(function() {
    console.log('页面加载完成，检查弹窗状态');
    // 这个超时函数只是为了确保所有元素都已加载
  }, 1000);
});
</script>
</body>
</html>